<!doctype html>
<html lang="en-us">

<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Emscripten-Generated Code</title>
    <style>
        .emscripten {
            padding-right: 0;
            margin-left: auto;
            margin-right: auto;
            display: block;
        }

        textarea.emscripten {
            font-family: monospace;
            width: 80%;
        }

        div.emscripten {
            text-align: center;
        }

        div.emscripten_border {
            border: 1px solid black;
        }
        /* the canvas *must not* have any border or padding, or mouse coords will be wrong */

        canvas.emscripten {
            border: 0px none;
            background-color: black;
        }

        .spinner {
            height: 50px;
            width: 50px;
            margin: 0px auto;
            -webkit-animation: rotation .8s linear infinite;
            -moz-animation: rotation .8s linear infinite;
            -o-animation: rotation .8s linear infinite;
            animation: rotation 0.8s linear infinite;
            border-left: 10px solid rgb(0, 150, 240);
            border-right: 10px solid rgb(0, 150, 240);
            border-bottom: 10px solid rgb(0, 150, 240);
            border-top: 10px solid rgb(100, 0, 200);
            border-radius: 100%;
            background-color: rgb(200, 100, 250);
        }

        @-webkit-keyframes rotation {
            from {
                -webkit-transform: rotate(0deg);
            }
            to {
                -webkit-transform: rotate(360deg);
            }
        }

        @-moz-keyframes rotation {
            from {
                -moz-transform: rotate(0deg);
            }
            to {
                -moz-transform: rotate(360deg);
            }
        }

        @-o-keyframes rotation {
            from {
                -o-transform: rotate(0deg);
            }
            to {
                -o-transform: rotate(360deg);
            }
        }

        @keyframes rotation {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.5/require.js"></script>
</head>

<body>
    <hr/>
    <figure style="overflow:visible;" id="spinner">
        <div class="spinner"></div>
        <center style="margin-top:0.5em">
            <strong>emscripten</strong>
        </center>
    </figure>
    <div class="emscripten" id="status">Downloading...</div>
    <div class="emscripten">
        <progress value="0" max="100" id="progress" hidden=1></progress>
    </div>
    <div class="emscripten_border">
        <canvas class="emscripten" id="canvas" oncontextmenu="event.preventDefault()"></canvas>
    </div>
    <hr/>
    <div class="emscripten">
        <input type="checkbox" id="resize">Resize canvas
        <input type="checkbox" id="pointerLock" checked>Lock/hide mouse pointer &nbsp;&nbsp;&nbsp;
        <input type="button" value="Fullscreen" onclick="oniguruma.requestFullscreen(document.getElementById('pointerLock').checked,
                                                                                document.getElementById('resize').checked)">
    </div>

    <hr/>
    <textarea class="emscripten" id="output" rows="8"></textarea>
    <hr>
    <button class="mybutton">Run myFunction</button>
    <script type='text/javascript'>
        require(['oniguruma'], function (oniguruma) {
            var statusElement = document.getElementById('status');
            var progressElement = document.getElementById('progress');
            var spinnerElement = document.getElementById('spinner');
            document.querySelector('.mybutton').addEventListener('click', function () {
                var vectorStr = new oniguruma.VectorString();
                // vectorStr.push_back('\\w(\\d+)');
                vectorStr.push_back('a');
                vectorStr.push_back('b');
                vectorStr.push_back('c');

                var scanner = new oniguruma.OnigScanner(vectorStr);

                var subject = 'xxaxxbxxc';
                var maxTestStringSize = (subject.length * 2 + 1) * 2;
                var testString = oniguruma._malloc(maxTestStringSize);
                oniguruma.stringToUTF8(subject, testString, maxTestStringSize);

                // scanner.test(testString, subject.length);
                result = scanner._findNextMatchSync(testString, subject.length, 4);
                for (var i = 0; i < result.Count(); i++) {
                    var indice = result.IndiceAt(i);
                    console.log(`start: ${indice.start}, end: ${indice.end}, length: ${indice.length}`);
                }

                class OnigRegExp {
                    constructor(source) {
                        this.source = source.toString()
                        var vectorStr = new oniguruma.VectorString();
                        vectorStr.push_back(this.source);

                        this.scanner = new oniguruma.OnigScanner(vectorStr)
                    }

                    captureIndicesForMatch(string, match) {
                        if (match) {
                            string = this.scanner.convertToString(string)

                            let captureIndices = [];
                            for (var i = 0; i < match.Count(); i++) {
                                var capture = match.IndiceAt(i);
                                capture.match = string.slice(capture.start, capture.end)
                                captureIndices.push(capture);
                            }
                            return captureIndices
                        } else {
                            return null
                        }
                    }

                    searchSync(string, startPosition) {
                        if (startPosition == null) startPosition = 0
                        let match = this.scanner.findNextMatchSync(string, startPosition)
                        return this.captureIndicesForMatch(string, match)
                    }

                    testSync(string) {
                        return this.searchSync(string) != null
                    }
                }

                oniguruma.OnigScanner.prototype.findNextMatchSync = function (string, startPosition) {
                    if (startPosition == null) {
                        startPosition = 0
                    }
                    string = this.convertToString(string)
                    startPosition = this.convertToNumber(startPosition)

                    var maxTestStringSize = (string.length * 2 + 1) * 2;
                    var testString = oniguruma._malloc(maxTestStringSize);
                    oniguruma.stringToUTF8(string, testString, maxTestStringSize);

                    let match = this._findNextMatchSync(testString, string.length, startPosition);

                    if (match) match.scanner = this
                    return match
                }

                oniguruma.OnigScanner.prototype.convertToString = function (value) {
                    if (value === undefined) return 'undefined'
                    if (value === null) return 'null'
                    return value.toString()
                }

                oniguruma.OnigScanner.prototype.convertToNumber = function (value) {
                    value = parseInt(value)
                    if (!isFinite(value)) {
                        value = 0
                    }
                    value = Math.max(value, 0)
                    return value
                }

                function expect(actual, expected) {
                    if (actual !== expected) {
                        console.log(`actual ${actual} !== expected ${expected}`);
                    }
                }

                function expectMatch(actual, expected) {
                    if (actual.index !== expected.index) {
                        console.log(`actual index ${actual.index} !== expected index ${expected.index}`);
                    }
                    if (actual.start !== expected.start) {
                        console.log(`actual start ${actual.start} !== expected start ${expected.start}`);
                    }
                    if (actual.end !== expected.end) {
                        console.log(`actual end ${actual.end} !== expected end ${expected.end}`);
                    }
                    if (actual.length !== expected.length) {
                        console.log(`actual length ${actual.length} !== expected length ${expected.length}`);
                    }
                }
                // OnigScanner, findNextMatchSync
                var vectorStr = new oniguruma.VectorString();
                vectorStr.push_back('a');
                vectorStr.push_back('b');
                vectorStr.push_back('c');
                scanner = new oniguruma.OnigScanner(vectorStr)
                expect(scanner.findNextMatchSync('x', 0), null)
                expect(scanner.findNextMatchSync('xxaxxbxxc', 0).index, 0)
                expect(scanner.findNextMatchSync('xxaxxbxxc', 4).index, 1)
                expect(scanner.findNextMatchSync('xxaxxbxxc', 7).index, 2)
                expect(scanner.findNextMatchSync('xxaxxbxxc', 9), null)

                vectorStr = new oniguruma.VectorString();
                vectorStr.push_back('1');
                vectorStr.push_back('2');
                scanner = new oniguruma.OnigScanner(vectorStr)
                expect(scanner.findNextMatchSync('abâ€¦cde21', 5).index, 1)


                vectorStr = new oniguruma.VectorString();
                vectorStr.push_back('\"');
                scanner = new oniguruma.OnigScanner(vectorStr)
                console.log('------');
                match = scanner.findNextMatchSync('{"â€¦": 1}', 1)
                expect(match.IndiceAt(0).index, 0);
                expect(match.IndiceAt(0).start, 1);
                expect(match.IndiceAt(0).end, 2);
                expect(match.IndiceAt(0).length, 1);

                // when the string searched contains surrogate pairs
                console.log('------');
                vectorStr = new oniguruma.VectorString();
                vectorStr.push_back('Y');
                vectorStr.push_back('X');
                scanner = new oniguruma.OnigScanner(vectorStr)
                match = scanner.findNextMatchSync('aðŸ’»bYX', 0)
                expectMatch(match.IndiceAt(0), {index: 0, start: 4, end: 5, length: 1})

                match = scanner.findNextMatchSync('aðŸ’»bYX', 1)
                expectMatch(match.IndiceAt(0), {index: 0, start: 4, end: 5, length: 1})

                match = scanner.findNextMatchSync('aðŸ’»bYX', 3)
                expectMatch(match.IndiceAt(0), {index: 0, start: 4, end: 5, length: 1})

                match = scanner.findNextMatchSync('aðŸ’»bYX', 4)
                expectMatch(match.IndiceAt(0), {index: 0, start: 4, end: 5, length: 1})

                match = scanner.findNextMatchSync('aðŸ’»bYX', 5)
                expect(match.index, 1)
                expectMatch(match.IndiceAt(0), {index: 0, start: 5, end: 6, length: 1})

                // when the input string contains invalid surrogate pairs
                console.log('------');
                vectorStr = new oniguruma.VectorString();
                vectorStr.push_back('X');
                scanner = new oniguruma.OnigScanner(vectorStr)
                match = scanner.findNextMatchSync(`X${String.fromCharCode(0xd83c)}X`, 0)
                expectMatch(match.IndiceAt(0), {index: 0, start: 0, end: 1, length: 1})

                // match = scanner.findNextMatchSync(`X${String.fromCharCode(0xd83c)}X`, 1)
                // expectMatch(match.IndiceAt(0), {index: 0, start: 2, end: 3, length: 1})

                // match = scanner.findNextMatchSync(`X${String.fromCharCode(0xd83c)}X`, 2)
                // expectMatch(match.IndiceAt(0), {index: 0, start: 2, end: 3, length: 1})

            });
        });
    </script>
    <!-- {{{ SCRIPT }}} -->
</body>

</html>